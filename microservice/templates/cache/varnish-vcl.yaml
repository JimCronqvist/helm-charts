{{- if .Values.cache.enabled }}
{{- $fullName := include "microservice.fullname" . -}}
{{- $labels := include "microservice.labels" (dict "context" $) -}}
{{- $svcPort := dig "port" 80 (default (dict) .Values.service) -}}
{{- $svcName := $fullName -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-varnish-vcl
  labels:
    {{- include "microservice.labels" (dict "context" $ "component" "varnish") | nindent 4 }}
data:
  {{- if .Values.cache.customVcl }}
  default.vcl: |
    {{- .Values.cache.customVcl | replace "${BACKEND_HOST}" $svcName | replace "${BACKEND_PORT}" ($svcPort | squote | replace "'" "") | nindent 4 }}
  {{- else }}
  default.vcl: |
    vcl 4.1;

    backend default {
      .host = "{{ $svcName }}";
      .port = "{{ $svcPort }}";
    }

    sub vcl_backend_fetch {
      set bereq.http.Host = "{{ $svcName }}";
    }

    sub vcl_recv {
      if (req.url ~ "/varnish/health") {
        error 200 "imok";
        set req.http.Connection = "close";
      }
    }
  {{- end }}
{{- end }}
